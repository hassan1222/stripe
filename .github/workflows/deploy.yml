name: Deploy to DigitalOcean

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H 159.223.118.251 >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        ssh root@159.223.118.251 << 'EOF'
          # Navigate to app directory (using /root/stripe instead of /opt/myapp)
          cd /root
          
          # Stop existing containers first
          cd stripe 2>/dev/null && docker-compose down || true
          
          # Remove existing code and clone fresh
          rm -rf stripe
          git clone https://github.com/${{ github.repository }} stripe
          cd stripe
          
          # Create nginx.conf from default.conf if it doesn't exist
          if [ ! -f nginx.conf ] && [ -f nginx/default.conf ]; then
            cp nginx/default.conf nginx.conf
          elif [ -f default.conf ]; then
            cp default.conf nginx.conf
          fi
          
          # Create server .env file with basic setup if it doesn't exist
          if [ ! -f server/.env ]; then
            echo "NODE_ENV=production" > server/.env
            echo "PORT=5000" >> server/.env
          fi
          
          # Clean up Docker to free space
          docker system prune -f
          
          # Build and start containers
          docker-compose up -d --build
          
          # Show what's running
          echo "=== Container Status ==="
          docker ps
          
          echo "=== Container Logs ==="
          docker-compose logs --tail=20
        EOF

    - name: Wait for services to start
      run: |
        echo "Waiting 60 seconds for all services to start..."
        sleep 60

    - name: Health check
      run: |
        echo "=== Health Check ==="
        
        # Check if containers are running
        ssh root@159.223.118.251 'cd /root/stripe && docker ps'
        
        # Test different endpoints
        echo "Testing main endpoint..."
        curl -f http://159.223.118.251 && echo "‚úÖ Main site works" || echo "‚ùå Main site failed"
        
        echo "Testing API endpoint..."
        curl -f http://159.223.118.251/api/ && echo "‚úÖ API works" || echo "‚ö†Ô∏è API might not have root endpoint"
        
        # Check individual services
        echo "Testing frontend directly..."
        curl -f http://159.223.118.251:3000 && echo "‚úÖ Frontend works" || echo "‚ùå Frontend failed"
        
        echo "Testing backend directly..."
        curl -f http://159.223.118.251:5000 && echo "‚úÖ Backend works" || echo "‚ùå Backend failed"
        
    - name: Deployment summary
      if: always()
      run: |
        if curl -s http://159.223.118.251 > /dev/null; then
          echo "üéâ Deployment successful! App is running at http://159.223.118.251"
        else
          echo "‚ö†Ô∏è Deployment completed but health check failed. Check container logs."
          ssh root@159.223.118.251 'cd /root/stripe && docker-compose logs'
        fi