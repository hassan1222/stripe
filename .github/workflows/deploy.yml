name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Copy files to droplet
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_SERVER }} << 'EOF'
          mkdir -p ${{ secrets.DEPLOY_PATH }}
        EOF
        rsync -avz --delete ./ ${{ secrets.DEPLOY_SERVER }}:${{ secrets.DEPLOY_PATH }}

    - name: Restart server on droplet
      run: |
        ssh ${{ secrets.DEPLOY_SERVER }} << 'EOF'
          cd ${{ secrets.DEPLOY_PATH }}/server
          
          # Create server .env file
          cat > .env << 'EOL'
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          NODE_ENV=production
          PORT=5000
          EOL
          
          npm install
          
          # Set production environment
          export NODE_ENV=production
          
          # Restart the server with PM2
          pm2 delete my-server || true
          pm2 start server.js --name my-server
          
          cd ../client
          
          # Create client .env file
          cat > .env << 'EOL'
          REACT_APP_API_URL=http://178.128.155.240:5000/api/auth
          EOL
          
          npm install
          npm run build
          
          # Check if build directory exists
          if [ ! -d "build" ]; then
            echo "Error: build directory not found"
            exit 1
          fi
          
          # Create /var/www/html if it doesn't exist
          sudo mkdir -p /var/www/html
          
          # Copy build files
          sudo cp -r build/* /var/www/html/
          
          # Set proper permissions
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html
          
          # Configure firewall to allow traffic on port 5000
          sudo ufw allow 5000/tcp
          
          # Restart nginx if it's installed
          sudo systemctl restart nginx || true
        EOF
